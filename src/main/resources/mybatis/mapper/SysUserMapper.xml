<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bdu.laborder.mapper.SysUserMapper">
    <resultMap type="com.bdu.laborder.common.core.domain.entity.SysUser" id="SysUserResult">
        <id     property="userId"       column="user_id"      />
        <result property="deptId"       column="dept_id"      />
        <result property="loginName"    column="login_name"   />
        <result property="password"     column="password"     />
        <result property="realName"     column="real_name"    />
        <result property="email"        column="email"        />
        <result property="mobile"       column="mobile"       />
        <result property="sex"          column="sex"          />
        <result property="avatar"       column="avatar"       />
        <result property="institute"    column="institute"    />
        <result property="major"        column="major"        />
        <result property="status"       column="status"       />
        <result property="isFirstLogin" column="is_firstlogin"/>
        <result property="delFlag"      column="del_flag"     />
        <result property="createBy"     column="create_by"    />
        <result property="createTime"   column="create_time"  />
        <result property="updateBy"     column="update_by"    />
        <result property="updateTime"   column="update_time"  />
        <association property="dept"    javaType="com.bdu.laborder.common.core.domain.entity.SysDept" resultMap="deptResult" />
        <collection  property="roles"   javaType="java.util.List"        resultMap="RoleResult" />
    </resultMap>

    <resultMap id="deptResult" type="com.bdu.laborder.common.core.domain.entity.SysDept">
        <id     property="deptId"   column="dept_id"     />
        <result property="parentId" column="parent_id"   />
        <result property="ancestors" column="ancestors"  />
        <result property="deptName" column="dept_name"   />
        <result property="orderNum" column="order_num"   />
        <result property="leader"   column="leader"      />
        <result property="status"   column="dept_status" />
    </resultMap>

    <resultMap id="RoleResult" type="com.bdu.laborder.common.core.domain.entity.SysRole">
        <id     property="roleId"       column="role_id"        />
        <result property="roleName"     column="role_name"      />
        <result property="roleKey"      column="role_key"       />
        <result property="roleSort"     column="role_sort"      />
        <result property="dataScope"     column="data_scope"    />
        <result property="status"       column="role_status"    />
    </resultMap>

    <sql id="userVo">
        select user_id, dept_id, login_name, password, real_name, email, mobile, sex, avatar,
               institute, major,
               status, is_firstlogin, del_flag,
               create_by, create_time, update_by, update_time
        from s_user
    </sql>

    <insert id="addUser">
        insert into `s_user` (
        <if test="userId != null and userId != ''">user_id,</if>
        <if test="deptId != null and deptId != ''">dept_id,</if>
        <if test="loginName != null and loginName != ''">login_name,</if>
        <if test="password != null and password != ''">password,</if>
        <if test="realName != null and realName != ''">real_name,</if>
        <if test="sex != null and sex != ''">sex,</if>
        <if test="mobile != null and mobile != ''">mobile,</if>
        <if test="email != null and email != ''">email,</if>
        <if test="avatar != null and avatar != ''">avatar,</if>
        <if test="status != null and status != ''">status,</if>
        <if test="createBy != null and createBy != ''">create_by,</if>
        create_time
        )values(
        <if test="userId != null and userId != ''">#{userId},</if>
        <if test="deptId != null and deptId != ''">#{deptId},</if>
        <if test="loginName != null and loginName != ''">#{loginName},</if>
        <if test="password != null and password != ''">#{password},</if>
        <if test="realName != null and realName != ''">#{realName},</if>
        <if test="sex != null and sex != ''">#{sex},</if>
        <if test="mobile != null and mobile != ''">#{mobile},</if>
        <if test="email != null and email != ''">#{email},</if>
        <if test="avatar != null and avatar != ''">#{avatar},</if>
        <if test="status != null and status != ''">#{status},</if>
        <if test="createBy != null and createBy != ''">#{createBy},</if>
        sysdate()
        )
    </insert>

    <update id="updateUser" parameterType="com.bdu.laborder.common.core.domain.entity.SysUser">
        update s_user
        <set>
            <if test="deptId != null and deptId != ''">dept_id = #{deptId},</if>
            <if test="loginName != null and loginName != ''">login_name = #{loginName},</if>
            <if test="password != null and password != ''">password = #{password},</if>
            <if test="realName != null and realName != ''">real_name = #{realName},</if>
            <if test="sex != null and sex != ''">sex = #{sex},</if>
            <if test="mobile != null and mobile != ''">mobile = #{mobile},</if>
            <if test="email != null and email != ''">email = #{email},</if>
            <if test="avatar != null and avatar != ''">avatar = #{avatar},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
            update_time = sysdate()
        </set>
        where `user_id`=#{userId}
    </update>

    <update id="updatePwd">
        update `s_user` set
        `password`=#{pwd},`is_firstlogin`="0"
        where `user_id`=#{id}
    </update>
    <update id="updateUserAvatar">
        update `s_user` set
        `avatar` = #{url} where `user_id`=#{id}
    </update>
    <delete id="deleteUser">
        UPDATE  s_user set del_flag = '1' WHERE user_id = #{id}
    </delete>

    <delete id="deleteUserByIds">
        update s_user set del_flag = '1' where user_id in
        <foreach collection="array" item="userId" open="(" separator="," close=")">
            #{userId}
        </foreach>
    </delete>

    <select id="getUserList" parameterType="com.bdu.laborder.common.core.domain.entity.SysUser" resultMap="SysUserResult">
        select u.user_id,u.dept_id,u.login_name,u.real_name,u.sex,u.mobile,u.email,u.avatar,
               u.status,u.institute,u.major,u.is_firstlogin,u.create_by, u.create_time,
               d.dept_name, d.leader,d.ancestors,r.role_id,r.role_name,r.role_sort
        from s_user u
        left join s_dept d on u.dept_id = d.dept_id
        left join s_user_role ur on u.user_id = ur.user_id
        left join s_role r on r.role_id = ur.role_id
        where u.del_flag = "0"
        <if test="loginName != null and loginName != ''">
            and (u.login_name like concat('%',#{loginName},'%') or u.real_name like concat('%',#{loginName},'%'))
        </if>
        <if test="status != null and status != ''">
            and u.status = #{status}
        </if>
        <if test="mobile != null and mobile != ''">
            and u.mobile like concat('%',#{mobile},'%')
        </if>
        <if test="deptId != null and deptId != ''">
            AND (u.dept_id = #{deptId} OR u.dept_id IN ( SELECT t.dept_id FROM s_dept t WHERE find_in_set(#{deptId}, ancestors) ))
        </if>
        <if test="roleId != null and roleId != ''">
            AND ur.role_id = #{roleId}
        </if>
        order by u.create_time desc,r.role_sort
    </select>

    <select id="getUserById" resultType="com.bdu.laborder.common.core.domain.entity.SysUser">
        <include refid="userVo" />
        where del_flag="0" and user_id=#{id}
    </select>
    <select id="selectUserByLoginName" resultType="java.lang.Integer">
        select user_id from s_user where login_name=#{loginName}
    </select>

    <update id="restPwd">
        update `s_user` set
        `password`=#{pwd},`is_firstlogin`="1"
        where `user_id`=#{id}
    </update>

    <update id="updateUserStatus">
        update `s_user` set
        `status` = #{status},`update_by`=#{updateBy},`update_time` =sysdate()
        where `user_id`=#{userId}
    </update>

    <select id="checkUserNameUnique" resultType="int">
        select count(1) from s_user where login_name = #{loginName} limit 1
    </select>

    <select id="checkPhoneUnique" resultMap="SysUserResult">
        select user_id, mobile from s_user where mobile = #{loginName} limit 1
    </select>

    <select id="checkEmailUnique" resultMap="SysUserResult">
        select user_id, email from s_user where email = #{email} limit 1
    </select>

</mapper>
