<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bdu.laborder.mapper.ClassroomOrderMapper">
    <resultMap id="classroomOrderResult" type="com.bdu.laborder.entity.ClassroomOrder">
        <id property="uuid" column="uuid"/>
        <result property="roomId" column="room_id"/>
        <result property="roomName" column="room_name" />
        <result property="roomAddress" column="room_address" />
        <result property="tableId" column="table_id"/>
        <result property="orderDate" column="order_date"/>
        <result property="orderNum" column="order_num"/>
        <result property="orderNode" column="order_node" />
        <result property="roomCap" column="room_cap"/>
        <result property="orderStatus" column="order_status" />
    </resultMap>

    <resultMap id="classroomOrderDetailResult" type="com.bdu.laborder.entity.ClassroomOrderDetail">
        <id property="uuid" column="uuid" />
        <result property="orderUser" column="order_user" />
        <result property="userName" column="user_name" />
        <result property="orderId" column="order_id" />
        <result property="classroomId" column="classroom_id" />
        <result property="classroomName" column="classroom_name" />
        <result property="orderDate" column="order_date" />
        <result property="orderNode" column="order_node" />
        <result property="orderStatus" column="order_status" />
        <result property="createTime" column="create_time"/>
        <result property="remark" column="remark" />
        <result property="deleteFlag" column="delete_flag"/>
        <collection  property="orderAudit"  javaType="java.util.List" resultMap="auditResult" />
    </resultMap>

    <resultMap id="auditResult" type="com.bdu.laborder.entity.OrderAudit">
        <id property="uuid" column="review_id" />
        <result property="orderRecordId" column="order_record_id" />
        <result property="type" column="type" />
        <result property="reviewUserId" column="review_user_id" />
        <result property="reviewUser" column="review_user" />
        <result property="reviewRemark" column="review_remark" />
        <result property="reviewTime" column="review_create_time" />
        <result property="state" column="state" />
        <result property="createTime" column="audit_create_time" />

    </resultMap>


    <select id="getClassroomCourse" resultMap="classroomOrderResult">
        SELECT
        o.uuid as uuid,
        r.uuid as room_id,r.name as room_name,r.address as room_address,r.cap as room_cap,r.status as order_status,
        t.uuid as table_id,o.order_num as order_num
        FROM
        ( SELECT * FROM s_classroom WHERE level = #{level} ) r
        LEFT JOIN
        ( SELECT * FROM s_course_table WHERE week = #{orderWeek} AND node = #{orderNode} ) t ON r.uuid = t.classroom_id
        LEFT JOIN
        s_order o ON r.uuid = o.room_id and o.order_date = #{orderDate} AND o.order_node = #{orderNode}

    </select>

    <select id="getOrderDetailByUserAndOrderId" resultMap="classroomOrderDetailResult">
        select uuid,order_user,order_id,classroom_id,
        order_date,order_node,order_status,create_time,remark
        from s_order_detail
        where order_user = #{userId} and  order_id = #{orderId} and delete_flag = '0'
    </select>

    <select id="selectClassroomOrderById" resultMap="classroomOrderResult">
        select uuid,room_id,order_date,order_node,order_num
        from s_order
        where uuid = #{id}
    </select>

    <insert id="insertOrderDetail">
        insert into s_order_detail (
        <if test="uuid != null and uuid != ''">uuid,</if>
        <if test="orderUser != null and orderUser != ''">order_user,</if>
        <if test="orderId != null and orderId != ''">order_id,</if>
        <if test="classroomId != null and classroomId != ''">classroom_id,</if>
        <if test="orderDate != null">order_date,</if>
        <if test="orderNode != null and orderNode != ''">order_node,</if>
        <if test="orderStatus != null and orderStatus != ''">order_status,</if>
        <if test="remark != null and remark != ''">remark,</if>
        create_time
        )values(
        <if test="uuid != null and uuid != ''">#{uuid},</if>
        <if test="orderUser != null and orderUser != ''">#{orderUser},</if>
        <if test="orderId != null and orderId != ''">#{orderId},</if>
        <if test="classroomId != null and classroomId != ''">#{classroomId},</if>
        <if test="orderDate != null">#{orderDate},</if>
        <if test="orderNode != null and orderNode != ''">#{orderNode},</if>
        <if test="orderStatus != null and orderStatus != ''">#{orderStatus},</if>
        <if test="remark != null and remark != ''">#{remark},</if>
        sysdate()
        )
    </insert>

    <insert id="insertOrder">
        insert into s_order (
        <if test="uuid != null and uuid != ''">uuid,</if>
        <if test="roomId != null and roomId != ''">room_id,</if>
        <if test="orderDate != null">order_date,</if>
        <if test="orderNode != null and orderNode != ''">order_node,</if>
        <if test="orderNum != null">order_num</if>
        )values (
        <if test="uuid != null and uuid != ''">#{uuid},</if>
        <if test="roomId != null and roomId != ''">#{roomId},</if>
        <if test="orderDate != null">#{orderDate},</if>
        <if test="orderNode != null and orderNode != ''">#{orderNode},</if>
        <if test="orderNum != null">#{orderNum}</if>
        )
    </insert>

    <update id="updateOrder">
        update s_order
        <set>
            <if test="roomId != null and roomId != ''">room_id = #{roomId},</if>
            <if test="orderDate != null">order_date = #{orderDate},</if>
            <if test="orderNode != null and orderNode != ''">order_node = #{orderNode},</if>
            <if test="orderNum != null">order_num = #{orderNum}</if>
        </set>
        where uuid = #{uuid}
    </update>
    <update id="updateOrderAudit">
        update s_order_audit
        <set>
            <if test="reviewRemark != null and reviewRemark != ''">review_remark = #{reviewRemark},</if>
            <if test="reviewUser != null and reviewUser != ''">review_user = #{reviewUser},</if>
            <if test="reviewUserId != null and reviewUserId != ''">review_user_id = #{reviewUserId},</if>
            <if test="state != null and state != ''">state = #{state},</if>
            review_time =  sysdate()
        </set>
        where order_record_id = #{orderRecordId} and type = #{type}
    </update>
    <update id="updateOrderDetailStatus">
        update s_order_detail set order_status = #{orderStatus} where uuid = #{id}
    </update>
    <update id="updateOrderNumById">
        update s_order set order_num = #{orderNum} where uuid = #{id}
    </update>

    <select id="checkOrderTime" resultMap="classroomOrderDetailResult">
        select classroom_id from s_order_detail
        where order_user = #{orderUser} and order_date = #{orderDate} and order_node = #{orderNode} limit 1
    </select>

    <select id="getOrderDetailByUser" resultMap="classroomOrderDetailResult">
        select od.uuid,od.order_user,od.order_id,od.classroom_id,c.name as classroom_name,
        od.order_date,od.order_node,od.order_status,od.create_time,od.remark,
        oa.uuid as review_id,oa.review_user,oa.type,oa.review_remark,oa.review_time as review_create_time
        from s_order_detail od
        left join s_classroom c on od.classroom_id = c.uuid
        left join s_order_audit oa on od.uuid = oa.order_record_id
        where
        od.delete_flag = '0' and order_user = #{userId}
        <if test="orderRequest.orderDate != null">
            AND od.order_date = #{orderRequest.orderDate}
        </if>
        <if test="orderRequest.orderNode != null and orderRequest.orderNode != ''">
            AND od.order_node = #{orderRequest.orderNode}
        </if>
        <if test="orderRequest.classroomName != null and orderRequest.classroomName != ''">
            AND c.name like concat('%',#{orderRequest.classroomName},'%')
        </if>
        order by create_time desc,review_create_time
    </select>

    <delete id="cencelOrderById">
        update s_order_detail set delete_flag = '1' where
        uuid = #{id}
    </delete>

    <insert id="insertOrderAudit">
        insert into s_order_audit (
            <if test="uuid != null and uuid != ''">uuid,</if>
            <if test="orderRecordId != null and orderRecordId != ''">order_record_id,</if>
            <if test="type != null and type != ''">type,</if>
            <if test="reviewRemark != null and reviewRemark != ''">review_remark,</if>
            <if test="reviewUser != null and reviewUser != ''">review_user,</if>
            <if test="reviewUserId != null and reviewUserId != ''">review_user_id,</if>
            <if test="state != null and state != ''">state,</if>
            create_time
        )values (
            <if test="uuid != null and uuid != ''">#{uuid},</if>
            <if test="orderRecordId != null and orderRecordId != ''">#{orderRecordId},</if>
            <if test="type != null and type != ''">#{type},</if>
            <if test="reviewRemark != null and reviewRemark != ''">#{reviewRemark},</if>
            <if test="reviewUser != null and reviewUser != ''">#{reviewUser},</if>
            <if test="reviewUserId != null and reviewUserId != ''">#{reviewUserId},</if>
            <if test="state != null and state != ''">#{state},</if>
            sysdate()
        )
    </insert>

    <select id="getOrderRecordByType" resultMap="classroomOrderDetailResult">
        SELECT
            od.uuid,u.real_name as user_name,od.order_id,r.name as classroom_name,
            od.order_date,od.order_node,od.order_status,od.create_time,od.remark,
            oa.uuid as review_id,oa.order_record_id,oa.review_user,oa.type,oa.review_remark,oa.review_time as review_create_time
        FROM
            s_order_detail od
            LEFT JOIN s_classroom r on od.classroom_id = r.uuid
            LEFT JOIN s_user u on od.order_user = u.user_id
            LEFT JOIN s_order_audit oa  on od .uuid  = oa.order_record_id
        WHERE
            od.delete_flag = '0'
            <if test="type != null and type != ''">AND oa.type = #{type}</if>
            <if test="orderRequest.state != null and orderRequest.state != ''">AND oa.state = #{orderRequest.state}</if>
            <if test='orderRequest.state != null and orderRequest.state == "1"'>AND oa.review_user_id = #{userId}</if>
            <if test="orderRequest.orderDate != null">AND od.order_date = #{orderRequest.orderDate}</if>
            <if test="orderRequest.orderNode != null and orderRequest.orderNode != ''">AND od.order_node = #{orderRequest.orderNode}</if>
            <if test="orderRequest.classroomName != null and orderRequest.classroomName != ''">AND r.name like concat('%',#{orderRequest.classroomName},'%')</if>
    </select>
    <select id="getOrderDetailById" resultMap="classroomOrderDetailResult">
        select * from s_order_detail where uuid = #{id}  and delete_flag = '0'
    </select>
</mapper>
